<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Tick Bags Scanner</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">

  <style>
    body { background-color: #f4f4f4; }
    .hidden { display: none !important; }
    .large-button { width: 100%; height: 100px; font-size: 1.5em; font-weight: bold; }

    #scanner-container {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.8); z-index: 999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    #reader {
        width: 90%; max-width: 500px; background-color: white; border: 2px solid #ddd;
    }
    #close-scanner-btn {
        position: absolute; top: 20px; right: 20px; font-size: 2em; color: white; cursor: pointer;
    }

    #scan-feedback {
        position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
        width: 90%; max-width: 400px; padding: 15px; border-radius: 8px;
        text-align: center; font-size: 1.2em; font-weight: bold; color: white;
        z-index: 1000; transition: bottom 0.3s ease-in-out;
    }
    #scan-feedback.show { bottom: 20px; }
    #scan-feedback.success { background-color: #28a745; }
    #scan-feedback.error { background-color: #dc3545; }

    .order-item { display: flex; align-items: center; margin-bottom: 10px; }
    .order-item img { width: 50px; height: 50px; margin-right: 15px; border-radius: 4px; }

    #search-modal-body .order-item img {
        width: 100px;
        height: 100px;
        object-fit: cover;
    }
    #search-modal-body .order-item {
        padding: 10px; border-bottom: 1px solid #eee;
    }
    #search-modal-body .order-item:last-child { border-bottom: none; }

    .table-items-col img {
        width: 40px;
        height: 40px;
        margin-right: 10px;
        border-radius: 4px;
    }
    .table-items-col div {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
  </style>
  <script src="{{ url_for('static', filename='html5-qrcode.min.js') }}"></script>
</head>
<body>
  <div class="container-fluid mt-4">
    <div id="main-view">
      <h2 id="view-title" class="text-center mb-4">Scan Orders</h2>
      <div id="main-buttons" class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="col-12 mb-3"><button id="search-btn" class="btn btn-primary large-button"><i class="fas fa-search"></i><br>Search Order</button></div>
            <div class="col-12 mb-3"><button id="dispatch-btn" class="btn btn-success large-button"><i class="fas fa-truck"></i><br>Scan for Dispatch</button></div>
            <div class="col-12 mb-3"><button id="return-btn" class="btn btn-danger large-button"><i class="fas fa-undo"></i><br>Scan for Return</button></div>
        </div>
      </div>

      <div id="list-view" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <button id="back-btn" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back</button>
          <h3 id="list-title"></h3>
          <button id="generate-report-btn" class="btn btn-primary">Generate Report</button>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-striped bg-white">
                <thead class="thead-dark">
                    <tr>
                        <th>Order #</th>
                        <th>Items</th>
                        <th class="text-center">Total Pieces</th>
                        <th class="text-center">Source</th>
                    </tr>
                </thead>
                <tbody id="order-list-body">
                </tbody>
            </table>
        </div>
      </div>
    </div>
  </div>

  <div id="scanner-container" class="hidden">
    <div id="reader"></div>
    <span id="close-scanner-btn">&times;</span>
  </div>

  <div id="scan-feedback"></div>

  <div class="modal fade" id="search-result-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="search-modal-title">Order Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body" id="search-modal-body"></div>
        </div>
    </div>
  </div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let activeList = [];
    let currentMode = '';
    let html5QrCode = null;

    const successSound = new Audio("{{ url_for('static', filename='success.mp3') }}");
    const errorSound = new Audio("{{ url_for('static', filename='error.mp3') }}");

    const mainButtons = document.getElementById('main-buttons');
    const listView = document.getElementById('list-view');
    const listTitle = document.getElementById('list-title');
    const orderListBody = document.getElementById('order-list-body');
    const scannerContainer = document.getElementById('scanner-container');
    const feedbackPanel = document.getElementById('scan-feedback');
    const generateReportBtn = document.getElementById('generate-report-btn');

    function showMainView() {
        listView.classList.add('hidden');
        mainButtons.classList.remove('hidden');
        document.getElementById('view-title').classList.remove('hidden');
    }

    function showListView(mode) {
        currentMode = mode;
        activeList = [];
        mainButtons.classList.add('hidden');
        document.getElementById('view-title').classList.add('hidden');
        listView.classList.remove('hidden');
        listTitle.textContent = `${mode} List (0)`;
        orderListBody.innerHTML = '<tr><td colspan="4" class="text-center">Scan your first order.</td></tr>';
        generateReportBtn.className = `btn ${mode === 'Dispatch' ? 'btn-success' : 'btn-danger'}`;
        generateReportBtn.textContent = `Generate ${mode} Report`;
        startScanner(); // <<< THE FIX IS HERE
    }

    function showFeedback(message, type) {
        feedbackPanel.textContent = message;
        feedbackPanel.className = ``;
        feedbackPanel.classList.add(type, 'show');

        const soundToPlay = (type === 'success') ? successSound : errorSound;
        soundToPlay.play().catch(error => {
            console.error(`Audio playback failed for ${type}.mp3:`, error);
        });

        setTimeout(() => { feedbackPanel.classList.remove('show'); }, 2000);
    }

    function onScanSuccess(decodedText) {
        if (currentMode === 'Search') {
            closeScanner();
            handleSingleSearch(decodedText);
        } else {
            handleOrderAddition(decodedText);
        }
    }

    function startScanner() {
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode('reader');
        }
        scannerContainer.classList.remove('hidden');
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess
        ).catch(err => {
            alert('Could not start camera. Please grant permission and try again.');
            closeScanner();
        });
    }

    function closeScanner() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.error("Error stopping scanner:", err));
        }
        scannerContainer.classList.add('hidden');
    }

    async function handleSingleSearch(searchTerm) {
        const order = await findOrder(searchTerm);
        if (order) {
            const modalTitle = document.getElementById('search-modal-title');
            const modalBody = document.getElementById('search-modal-body');

            modalTitle.textContent = `Order #${order.order_id}`;
            modalBody.innerHTML = order.line_items.map(item => `
                <div class="order-item">
                    <img src="${item.image_src || ''}" alt="Product Image">
                    <div class="flex-grow-1">
                        <strong>${item.product_title}</strong>
                        <p class="mb-0">Quantity: ${item.quantity}</p>
                    </div>
                </div>
            `).join('');

            $('#search-result-modal').modal('show');
        } else {
            alert('Order not found!');
        }
    }

    async function handleOrderAddition(searchTerm) {
        if (!searchTerm) return;

        const order = await findOrder(searchTerm);

        if (!order) {
            showFeedback('Order not found!', 'error');
            return;
        }

        if (activeList.some(existingOrder => existingOrder.order_id === order.order_id)) {
            showFeedback('Duplicate order!', 'error');
            return;
        }

        activeList.unshift(order);
        populateOrderList();
        showFeedback(`Added: ${order.order_id}`, 'success');
    }

    async function findOrder(searchTerm) {
        try {
            const response = await fetch(`/scan?term=${encodeURIComponent(searchTerm)}`);
            if (!response.ok) return null;
            return await response.json();
        } catch (error) {
            return null;
        }
    }

    function populateOrderList() {
        listTitle.textContent = `${currentMode} List (${activeList.length})`;
        if (activeList.length === 0) {
            orderListBody.innerHTML = '<tr><td colspan="4" class="text-center">Scan your first order.</td></tr>';
            return;
        }

        orderListBody.innerHTML = activeList.map(order => {
            const totalPieces = order.line_items.reduce((sum, item) => sum + item.quantity, 0);
            const itemsHtml = order.line_items.map(item => `
                <div>
                    <img src="${item.image_src || ''}" alt="Item Image">
                    <span>${item.product_title} (x${item.quantity})</span>
                </div>
            `).join('');

            return `
                <tr>
                    <td><strong>#${order.order_id}</strong></td>
                    <td class="table-items-col">${itemsHtml}</td>
                    <td class="text-center align-middle"><strong>${totalPieces}</strong></td>
                    <td class="text-center align-middle"><span class="badge badge-info p-2">${order.source.toUpperCase()}</span></td>
                </tr>
            `;
        }).join('');
    }

    async function generateReport() {
        if (activeList.length === 0) return alert(`No orders to generate ${currentMode} report.`);

        const shopifyOrders = activeList.filter(o => o.source === 'shopify' && o.id);
        const tag = currentMode;

        if (shopifyOrders.length > 0) {
            try {
                await Promise.all(shopifyOrders.map(order => fetch("/apply_tag", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ order_id: order.id, tag: tag })
                })));
            } catch (error) { return alert("Error applying tags."); }
        }

        if (currentMode === "Dispatch") {
            const cnNumbers = [...new Set(activeList.flatMap(o => o.line_items.map(item => item.tracking_number)).filter(Boolean))];
            if (cnNumbers.length > 0) {
                 try {
                    const response = await fetch("/generate_loadsheet", {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ cn_numbers: cnNumbers })
                    });
                    const data = await response.json();
                    if (!response.ok || data.status !== 1) throw new Error(data.error_message || 'Failed to generate loadsheet.');
                } catch (error) { return alert(`Error generating loadsheet: ${error.message}`); }
            }
        }

        alert(`${currentMode} report generated successfully for ${activeList.length} orders!`);
        activeList = [];
        populateOrderList();
        showMainView();
    }

    function initializeScanMode(mode, action) {
        successSound.play().catch(()=>{});
        successSound.pause();
        errorSound.play().catch(()=>{});
        errorSound.pause();
        action(mode);
    }

    document.getElementById('search-btn').addEventListener('click', () => initializeScanMode('Search', (m) => { currentMode = m; startScanner(); }));
    document.getElementById('dispatch-btn').addEventListener('click', () => initializeScanMode('Dispatch', showListView));
    document.getElementById('return-btn').addEventListener('click', () => initializeScanMode('Return', showListView));
    document.getElementById('close-scanner-btn').addEventListener('click', closeScanner);
    document.getElementById('back-btn').addEventListener('click', () => { closeScanner(); showMainView(); });
    generateReportBtn.addEventListener('click', generateReport);
});
</script>
</body>
</html>
